@using Newtonsoft.Json;
@{
    ViewData["Title"] = "ResultadosDeLaBusqueda";
}

@foreach (var item in ViewBag.hotelesConCostoTotal)
{
    var hotel = item.hotel;
    var costo = item.costo;

    @foreach (Vuelo vuelo in ViewBag.vuelos)
    {
        @if (hotel.ciudad_fk == vuelo.destino_fk)
        {
            double personas = ViewBag.total_adultos + (ViewBag.total_menores - ViewBag.total_menores * 0.15);
            double costo_vuelo = vuelo.costo * personas;
            double total = costo_vuelo + costo;
            double impuesto_pais = total * 0.3;
            double RG_4815 = total * 0.45;
            double RG_5272 = total * 0.05;
            double impuestos = impuesto_pais + RG_4815 + RG_5272;
            double descuento = Math.Round(total * 0.0661, 2);
            double suma_total = total + impuestos - descuento;
            double precio_por_persona = suma_total / ViewBag.total_personas;

            string codigoOrigen = vuelo.origen.nombre.ToUpper().Substring(0, Math.Min(3, vuelo.origen.nombre.Length));
            string codigoDestino = vuelo.destino.nombre.ToUpper().Substring(0, Math.Min(3, vuelo.destino.nombre.Length));

            <div class="box-container">
                <div class="box row d-flex">
                    <div class="col-md-4 p-0 hotel-image">
                        @if (!string.IsNullOrEmpty(hotel.imagen))
                        {
                            <img src="~/@hotel.imagen" alt="Imagen del hotel" />
                        }
                        else
                        {
                            <img src="~/images/noImageFound.png" alt="Imagen no encontrada" />
                        }
                    </div>
                    <div class="content border-end col-md-5">
                        <h3 class="fs-4 fw-semibold m-0"><i class="bx bxs-map icon"></i> @hotel.nombre</h3>
                        <p class="location-distance p-0 m-0 mb-2">
                            @hotel.descripcion
                            <a href="#" class="text-decoration-none ms-1 map">Ver en mapa</a>
                        </p>
                        <div class="stars mb-2 fs-6">
                            <span class="fw-semibold rating me-1 py-0">8.1</span>
                            <i class="bx bxs-star icon">
                                <i class="bx bxs-star icon">
                                    <i class="bx bxs-star icon">
                                        <i class="bx bxs-star icon"><i class="bx bx-star icon"></i></i>
                                    </i>
                                </i>
                            </i>
                        </div>
                        <span class="px-2 fw-semibold capacity-alert">Solo quedan 3</span>
                        <div class="d-flex align-items-center fs-6">
                            <i class="bx bxs-plane-alt icon pe-1 pt-0 mb-3 fs-4"></i>
                            <p class="pt-0">Vuelo directo @codigoOrigen</p>
                            <i class="bx bx-transfer icon px-1 pt-0 mb-3 fs-5"></i>
                            <p class="pt-0">@codigoDestino</p>
                        </div>
                    </div>
                    <div class="mt-3 payment-info col-md-3">
                        <p class="mb-0">Vuelo + Alojamiento</p>
                        <p class="mb-1">Precio final por persona</p>
                        <div class="d-flex align-items-center">
                            <i type="button" class="bx bx-info-circle icon fs-4 text-primary pe-2"
                               data-bs-toggle="modal" data-bs-target="#payment-modal"></i>
                            <div class="modal fade" id="payment-modal" tabindex="-1" aria-labelledby="title"
                                 aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content modal-width p-2">
                                        <div class="modal-body pb-0 border-bottom">
                                            <div class="row d-flex justify-content-between">
                                                <h1 class="fs-4 fw-semibold col-10 mb-0">
                                                    Detalle de precio
                                                </h1>
                                                <button type="button" class="btn-close col-2 fs-5 pe-4"
                                                        data-bs-dismiss="modal" aria-label="Close">
                                                </button>
                                            </div>
                                            @if (ViewBag.total_menores == 0 && ViewBag.total_adultos == 1)
                                            {
                                                <p class="d-block">Para @ViewBag.total_adultos adulto</p>
                                            }
                                            else if (ViewBag.total_menores == 0 && ViewBag.total_adultos > 1)
                                            {
                                                <p class="d-block">Para @ViewBag.total_adultos adultos</p>
                                            }
                                            else if (ViewBag.total_menores > 1 && ViewBag.total_adultos > 1)
                                            {
                                                <p class="d-block">Para @ViewBag.total_adultos adultos y @ViewBag.total_menores menores </p>
                                            }
                                            else
                                            {
                                                <p class="d-block">
                                                    Para @ViewBag.total_adultos adultos adultos y @ViewBag.total_menores menor
                                                </p>
                                            }
                                            <div class="row d-flex payment-small-font">
                                                <p class="col-9 mb-0">Vuelo</p>
                                                <p class="col-3 mb-0 px-0 text-end pe-3">$ @costo_vuelo</p>
                                            </div>
                                            <p class="d-block text-body text-opacity-50">Ida y vuelta directo</p>
                                            <div class="row d-flex payment-small-font">
                                                <p class="col-9 mb-0">Alojamiento</p>
                                                <p class="col-3 mb-0 px-0 text-end pe-3">$ @costo</p>
                                            </div>
                                            <p class="d-block text-body text-opacity-50">
                                                @hotel.nombre x @ViewBag.cantDias noches
                                            </p>
                                        </div>
                                        <div class="modal-body pb-0 border-bottom">
                                            <div class="row d-flex payment-small-font">
                                                <p class="col-9 mb-2">Precio Total</p>
                                                <p class="col-3 mb-2 px-0 text-end pe-3">$ @total</p>
                                            </div>
                                            <div class="row d-flex payment-small-font">
                                                <p class="col-9 mb-0">Impuestos, tasas y cargos incluidos</p>
                                                <p class="col-3 mb-0 px-0 text-end pe-3">
                                                    $@impuestos
                                                </p>
                                            </div>
                                            <p class="d-block text-body text-opacity-50">
                                                Incluye Impto. PAIS y
                                                Percepciones RG 4815 y 5272
                                            </p>
                                            <div class="row d-flex text-success payment-small-font">
                                                <p class="col-9 mb-2">Ahorro paquete</p>
                                                <p class="col-3 mb-2 px-0 text-end pe-3 text-nowrap">
                                                    - $@descuento
                                                </p>
                                            </div>
                                        </div>
                                        <div class="row d-flex justify-content-between fw-semibold ps-3 pe-3 pt-2 payment-small-font">
                                            @if (ViewBag.personas > 1)
                                            {
                                                <p class="col-9">Final @ViewBag.total_personas personas</p>
                                            }
                                            else
                                            {
                                                <p class="col-9">Final @ViewBag.total_personas persona</p>
                                            }

                                            <p class="col-3 px-0 text-end pe-3 text-nowrap">
                                                $@suma_total
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="fs-6 mb-0">$ <span class="fs-4">@precio_por_persona</span></p>
                        </div>
                        @if (ViewBag.total_personas > 1)
                        {
                            <p class="fw-semibold mb-0 text-nowrap">Final @ViewBag.total_personas personas <span>$@suma_total</span></p>
                        }
                        else
                        {
                            <p class="fw-semibold mb-0 text-nowrap">Final @ViewBag.total_personas persona <span>$@suma_total</span></p>
                        }
                        <p class="tax-message">Incluye Impto. PAIS y Percepciones</p>
                        <button class="btn btn-warning rounded-pill buy-button"
                                data-hotel="@JsonConvert.SerializeObject(ViewBag.hotel)"
                                data-flight="@JsonConvert.SerializeObject(ViewBag.vuelo)"
                                data-start_date="@ViewBag.fecha_desde"
                                data-end_date="@ViewBag.fecha_hasta"
                                data-total="suma_total"
                                data-sm_rooms="@ViewBag.habitaciones_chicas"
                                data-md_rooms="@ViewBag.habitaciones_medianas"
                                data-xl_rooms="@ViewBag.habitaciones_grandes"
                                data-people="@ViewBag.total_personas">
                            Comprar
                        </button>

                    </div>
                </div>
            </div>
        }
    }
}